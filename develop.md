# EasyCenter 程序中控系统开发文档

## 概述
本系统用于对非开源程序进行授权控制、API收费调度、程序更新、流量统计等。
采用Thinkphp8.0框架进行开发。

## 功能模块

### 安全验证
这是一个全局适用的模块，应当**通过中间件**实现，即客户端在进行云端请求的时候需要携带云端生成的token以进行身份验证，在客户端和云端都需要储存token，并且判断是否过期，如果token过期则需要重新生成。
token的生成方式:
授权的网站域名+token起始时间戳+随机数并进行Md5计算。

#### 业务实现

在中间件`middleware\Verifty.php`中实现请求检验，首先在请求头中必须包含`Authorization`字段，字段值为token值，token需要在客户端本地储存。

token验证有两种可能，如果token过期，则返回token失效，此时客户端需要通过生成token的接口请求新的token。如果token不正确则返回验证失败。

token应该在添加授权的时候首次生成，如果返回token失效则客户端需要再次获取新的token。


### 授权验证

#### 概述

用于对网站授权检测，如果没有授权则截停访问。同时需要配合安全验证模块防止恶意检测以及撞库等。


### 在线更新
#### 概述

在线更新的核心是检查程序版本，并且判断版本优先级，当对应的平台版本低于最新版本的时候，执行更新。
更新通过补丁包的方式覆盖现有旧版本文件来更新，同时为了保证稳定性，应当对被覆盖的文件进行备份操作以便在更新出现错误时回退版本。
由于可能有数据库文件的更新，所以还要通过SQL语句来执行数据表更新，同时为防止更新出错，对数据库进行备份以方面回滚。
考虑到不同的平台会有定制需求，所以对不同的平台指定不同的补丁。默认情况下授权的平台的补丁是公共补丁，通过单独指定补丁存放路径即可实现不同的平台使用不同的补丁进行更新。


#### 业务实现

#####  业务流程
实现在线更新的备选方案有两种：

1.客户端本地储存版本号，通过云端接口获取最新版本，当当前版本落后云端版本的时候，执行更新。

2.云端储存授权的客户端和客户端版本号，客户端向云端发送检查请求，当客户端需要更新的时候通知客户端执行更新，并在客户端更新完成之后通知更新完成，服务端更新到最新的版本。

二者各有利弊。如果用客户端储存的话，可能由于客户失误操作修改版本号而导致的问题。
如果用云端的话，可能导致用户回传失败，云端没有接受到客户升级完成的通知而导致重复更新。

最终决定二者融合：
1.云端检查作为独立的一部分，客户端请求的时候**应当携带当前版本的参数表明客户端有在本地储存的版本号。**

2.如果没有此参数，说明客户端没有在本地储存参数，则以云端为主，如果云端的版本号落后则通知客户端更新。

3.如果客户端请求时携带的当前本地版本号和云端的当前客户端版本号不一致，则提示冲突，客户端需要选择覆盖哪个版本。

##### 逻辑设计

首先，无论是检查更新还是执行更新，全部通过API的方式实现。

因此在客户端需要有供服务端调用的发起更新的API，服务端也要有供客户端检查信息的API。

检查更新的逻辑：

提供一段
php代码或者封装的方法向服务端请求版本查询，服务端收到请求之后判断是否有携带本地版本参数，如果有则对比双方版本是否一致，不一致返回提示选择覆盖，一致则接着通过当前版本对比最新版本进行检查最新版本和当前版本的操作，当检查到新版本时向客户端确认是否更新。如果不存在本地版本号，则以云端为准，检查是否需要更新。

更新操作的逻辑：
在用户确认更新的时候，向客户端本地发起更新的通知，客户端对请求参数鉴权，包括来源主机、token等。服务端在请求时应当携带客户端需要更新到的版本号，客户端检查没有异常之后，根据版本号向服务端获取补丁包，补丁包应当是一个压缩文件，客户端下载完毕之后解压到临时目录，对当前补丁包会覆盖的文件进项备份，然后覆盖现在的文件，并且删除临时目录。当完成更新的之后，通知服务端更新完成，通知应当携带更新之后的版本号以及备份文件的地址和其他的更新信息，服务端收到通知之后，更新云端数据库中的版本号和客户端的更新记录。

##### 代码实现
需要生产的API接口：

服务端：

1. 检查是否需要更新的接口。

2. 接受客户端确认更新的接口

3. 客户端获取补丁包的接口


客户端：

1. 服务端通知更新的接口